{% extends "dashboard/base.html" %}
{% block content %}
<h3 class="mb-3">Jobs</h3>

<form class="row g-2 mb-3">
  <div class="col-md-3">
    <input name="q" value="{{ q }}" class="form-control" placeholder="Role / keywords" />
  </div>
  <div class="col-md-3">
    <input name="location" value="{{ location }}" class="form-control" placeholder="Location (e.g., Lagos)" />
  </div>
  <div class="col-md-2">
    <select name="source" class="form-select">
      <option value="">All (filter)</option>
      <option value="all" {% if source == "all" %}selected{% endif %}>All (scrape)</option>
      <option value="indeed" {% if source == "indeed" %}selected{% endif %}>Indeed</option>
      <option value="glassdoor" {% if source == "glassdoor" %}selected{% endif %}>Glassdoor</option>
      <option value="linkedin" {% if source == "linkedin" %}selected{% endif %}>LinkedIn</option>
    </select>
  </div>
  <div class="col-md-1">
    <input name="pages" type="number" min="1" max="5" value="{{ pages|default:'1' }}" class="form-control" title="Pages to fetch" />
  </div>
  <div class="col-md-1">
    <button class="btn btn-primary w-100">Filter</button>
  </div>
  <div class="col-md-2">
    <button class="btn btn-secondary w-100" name="action" value="scrape">Search &amp; Fetch</button>
  </div>
</form>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} my-2">{{ message }}</div>
  {% endfor %}
{% endif %}

{% if last_run %}
  <p class="text-muted">
    Last synced: {{ last_run.finished_at|default:last_run.started_at }}
    ({{ last_run.source }}: {{ last_run.status }}, saved {{ last_run.total_saved }}/{{ last_run.total_found }})
  </p>
{% endif %}

<div class="list-group">
  {% for job in page_obj %}
    <div class="list-group-item">
      <div class="d-flex w-100 justify-content-between align-items-start">
        <h5 class="mb-1">
          {% if job.url %}
            <a href="{{ job.url }}" target="_blank" rel="noopener">{{ job.title }}</a>
          {% else %}
            {{ job.title }}
          {% endif %}
        </h5>
        <small class="text-nowrap">{{ job.created_at|date:"Y-m-d H:i" }}</small>
      </div>

      {% if job.company or job.location or job.is_remote or job.salary_raw %}
        <p class="mb-1">
          {% if job.company %}{{ job.company }}{% endif %}
          {% if job.company and job.location %} â€” {% endif %}
          {% if job.location %}{{ job.location }}{% endif %}
          {% if job.is_remote %}
            <span class="badge text-bg-success ms-1">Remote</span>
          {% endif %}
          {% if job.salary_raw %}
            <span class="badge text-bg-info ms-1">{{ job.salary_raw }}</span>
          {% endif %}
        </p>
      {% endif %}

      <div class="d-flex justify-content-between">
        <small class="text-secondary">{{ job.source|capfirst }}</small>
        <small>
          <a href="{% url 'job_detail' job.id %}" class="text-decoration-none">Details</a>
        </small>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-info">No jobs found. Try different filters.</div>
  {% endfor %}
</div>

<nav class="mt-3">
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ page_obj.previous_page_number }}&q={{ q }}&location={{ location }}&source={{ source }}&remote={{ remote }}&pages={{ pages }}">Previous</a>
      </li>
    {% endif %}
    <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ page_obj.next_page_number }}&q={{ q }}&location={{ location }}&source={{ source }}&remote={{ remote }}&pages={{ pages }}">Next</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endblock %}
